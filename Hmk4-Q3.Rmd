---
title: "Hmk4-Q3"
author: "Ling He"
date: "11/12/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### **Introduction**
We will use Spotify playlist data in our final project. Specifically, we plan to collect our classmates' Spotify "Your Top Songs 2017" playlists. We are curious about different metrics of each song, and how they correlate with each other or other variables. For this homework assignment, I will examine the energy variable out of the following 7 song metrics, valence, danceability, instrumentalness, energy, acousticness, liveness, and speechiness. Each of these metrics have values between 0 and 1, representing the level of each variable. Energy represents a perceptual measure of intensity and activity of a song. 

### **Data**

```{r}
#load the data using api
library(spotifyr)
Sys.setenv(SPOTIFY_CLIENT_ID = '0b3813c7cd26432c841f9c000a96697e')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '5a7943eedb8948abb42b6a1df709e47b')

access_token <- get_spotify_access_token()

library(tidyverse)

playlist_Hammand <- get_playlist_audio_features("1256140081", "37i9dQZF1E9ECwVUJQFrgP")
playlist_Danielle <- get_playlist_audio_features("danielle219", "37i9dQZF1E9Lke9WJ01eT7")
playlist_Kelly <- get_playlist_audio_features("22ugjl3xvvzgwtbwi3ubpt72a", "37i9dQZF1E9VRPVezelVUk")
playlist_Lea <- get_playlist_audio_features("leac750", "37i9dQZF1E9UKwJS1D9012")


playlist_Hammand$owner = "Hammand"
playlist_Danielle$owner = "Danielle"
playlist_Kelly$owner = "Kelly"
playlist_Lea$owner = "Lea" 

playlists = list(playlist_Hammand, playlist_Danielle, playlist_Kelly, playlist_Lea)

#join playlists with genre
for (i in 1: length(playlists)){
  artists<- unique(playlists[[i]]$artist_name)
  genre<- get_artists(artists[1], return_closest_artist = TRUE)
  
  for(j in 2:length(artists)){
    genre<- rbind(genre, get_artists(artists[j], return_closest_artist = TRUE))
  }
  
  playlists[[i]] <- playlists[[i]] %>% left_join(genre)
}

library(fmsb)

#select the song metrics variables and combine them into one data frame
out_df <- NULL
for (i in 1: length(playlists)){
  variables <- playlists[[i]] %>% select(valence, danceability, instrumentalness,
                            energy, acousticness, liveness, speechiness, owner,
                            artist_genres, artist_name)

  out_df <- rbind(out_df, variables)
}
```
We collected "Your Top Songs 2017" playlists of our four team members, and organized it into a desirable format for our analysis.

### **Exploratory Analysis**

```{r}

library(pgmm)
library(GGally)

ggparcoord(out_df, columns = 1:7, alphaLines = .3, 
           scale = "uniminmax", groupColumn = "owner", splineFactor = 10) +
  ggtitle("How different is everyone's 2017 playlist? ") +
  theme_minimal()
  

```
The above parallel coordinate plot shows the song metrics pattern for each of our team members. This provides a holistic view of all 7 song metrics. We observe that Kelly's pattern is distinctly different from all her teammates. In particular, she has relatively lower values of energy and speechiness, and higher values of acousticness. We are curious about what the contributing factors are to everyone's pattern. 


```{r}
ggplot(out_df, aes(x=energy, color=owner)) +
  geom_density() + 
  ggtitle("Density plots of energy metric") +
  theme_minimal()
```

We then dive into the energy variable. From the density plot, we see the distribution of energy across each person's playlist. There are several interesting observations. Everyone's distribution appears to be unimodal except for Kelly's, indicating that Kelly might like to listen to a wider range of music while everyone else prefers a particular type of music. In addition, Danielle, Hammand, and Lea's energy distributions are all skewed to the left, showing that they all prefer to listen to music with relatively higher energy. 

```{r}
artist_top_genres <- NULL

for (i in 1: nrow(out_df)){
  if (is.null(out_df$artist_genres[[i]][1])){
    artist_top_genres <- rbind(artist_top_genres, "N/A")
  }
  
  else{
    artist_top_genres <- rbind(artist_top_genres,  out_df$artist_genres[[i]][1])
  }
  
}

out_df$artist_top_genre <- as.factor(as.vector(artist_top_genres))

grouped_owner_genre <- out_df %>% group_by(artist_top_genre, owner) %>% 
  summarise(n=n())
top_genres <- (grouped_owner_genre %>% filter(n>12))$artist_top_genre

ggplot(out_df %>% filter(artist_top_genre %in% top_genres) %>% 
         filter(artist_top_genre != "N/A"), aes(x=energy, color=owner)) +
  geom_density() + 
  ggtitle("Density plots of energy metric by artist genre") +
  theme_minimal()+
  facet_grid(. ~ artist_top_genre)

```

We are curious about if genre of music contributes to the energy variable. Intuitively, certain genres such as electric dance music (edm) would have higher energy than acoustic music. We then plotted density plots by the top 4 genres of all the songs (note: each song can belong to multiple genres, but here we only look at the first genre of each song's genre list). We observe that except for dance pop, only two owners listen to each genre. In particular, Lea likes to listen to high energy music from alternative dance and edm, while hammand likes to listen to high energy music from dance pop. These density plots provide us with a more comprehensive view of how the energy variable distributes across genres. 

```{r}

energy_by_artist <- out_df %>% group_by(artist_name, owner) %>% 
  summarise(n=n(), mean_energy = mean(energy)) %>% arrange(-n) 

ggplot(energy_by_artist %>% filter(n>=3), 
       aes(x=artist_name, y=mean_energy, color = owner)) +
  geom_col(fill="white") + 
  ggtitle("Which artists have the most energetic songs?") +
  theme_minimal()+
  facet_wrap(~owner)+
  theme(axis.text.x = element_text(size = 5, angle = 45, hjust = 1))

```

After we looked at the genres of music, we wonder that if someone listens to music that has high energy, does it mean all his/her songs have high energy? How is the energy variable distributed across everyone's favorite artists? We calculated the average energy of each artist and plotted the energy values of artists that have at least 3 songs in our overall playlist data. Since people can listen to vastly different artists, there might not be much overlap among the owners. However, from the histograms above, we see that Danielle and Lea's favorite artists have relatively similar energy level while Kelly and Hammand favorite artists have relatively different energy level. This observation helps us to learn about everyone's music preference, variety and patterns. 
